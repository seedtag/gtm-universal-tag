___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Seedtag - Universal Tag",
  "categories": [
    "ADVERTISING",
    "CONVERSIONS",
    "LEAD_GENERATION",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Seedtag",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "This template adds the Seedtag Universal Tag.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pid",
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^[0-9]+-[0-9a-f]{20}$"
        ]
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "type",
    "displayName": "Type",
    "selectItems": [
      {
        "value": "visit",
        "displayValue": "Visit"
      },
      {
        "value": "lead",
        "displayValue": "Lead"
      }
    ],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const sendPixel = require('sendPixel');
const encodeUri = require('encodeUri');
const copyFromDataLayer = require('copyFromDataLayer');
const getReferrerUrl = require('getReferrerUrl');
const getUrl = require('getUrl');
const generateRandom = require('generateRandom');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const getTimestampMillis = require('getTimestampMillis');
const encodeUriComponent = require('encodeUriComponent');

// If there is already a first party cookie no need to create new uuid, but we need to update expire date to 30 days.
var cid = getCookieValues('_km')[0];
if (cid === undefined) {
    cid = uuid();
}

// Set the first party cookie
setCookie('_km', cid, { 'max-age': 30 * 24 * 60 * 60, 'secure': true });

// If event is a seedtag.timer then it's a qualified visit, we can record a close.
let isTimer = copyFromDataLayer('event') === 'seedtag.timer';

// Optional eventData could be set in data layer
let eventData = copyFromDataLayer('eventData');

var sUrl = 'https://t.kmtx.io/s?' +
    'pid=' + encodeUriComponent(data.pid) +
    '&cid=' + cid +
    '&eid=' + uuid() +
    '&a=' + (isTimer ? 'close' : data.type) +
    '&ed=' + (eventData === undefined ? '' : encodeUriComponent(eventData)) +
    '&v=gtm_2' +
    '&url=' + encodeUri(getUrl()) +
    '&ref=' + encodeUri(getReferrerUrl()) +
    '&ts=' + getTimestampMillis() +
    '&trk=trkid' +
    '&t=img';

sendPixel(sUrl, data.gtmOnSuccess, data.gtmOnFailure);

// Function to generate random UUIDv4
function uuid() {
    var chars = '0123456789abcdefghijklmnopqrstuvwxyz'.split('');
    var uuid = [];
    var rnd = 0;
    var r;
    for (var i = 0; i < 36; i++) {
        if (i == 8 || i == 13 || i == 18 || i == 23) {
            uuid[i] = '-';
        } else if (i == 14) {
            uuid[i] = '4';
        } else {
            if (rnd <= 2) rnd = 33554432 + ((generateRandom(0, 100000) / 100000) * 16777216) | 0;
            r = rnd & 15;
            rnd = rnd >> 4;
            uuid[i] = chars[(i == 19) ? (r & 3) | 8 : r];
        }
    }
    return uuid.join('');
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_km"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "event"
              },
              {
                "type": 1,
                "string": "eventData"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://t.kmtx.io/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_km"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: gtmOnSuccess is invoked on sendPixel success
  code: |-
    // test that gtmOnSuccess() is called when sendPixel succeeds
    mock('sendPixel', function(url, onSuccess, onFailure) {
      if (onSuccess != null) {
        onSuccess();
      }
    });

    // Call runCode to run the template's code.
    runCode({
      pid: '1-ade456ef78ade456ef78',
      type: 'visit'
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: gtmOnFailure is invoked when sendPixel fails
  code: |-
    // test gtmOnFailure() is called when sendPixel fails
    mock('sendPixel', function(url, onSuccess, onFailure) {
      if (onFailure != null) {
        onFailure();
      }
    });

    // Call runCode to run the template's code.
    runCode({
      aid: '1-ade456ef78ade456ef78',
      type: 'visit'
    });

    // Verify onFailure was called
    assertApi('gtmOnFailure').wasCalled();
- name: setCookie is invoked with new UUID
  code: |-
    var triggerUrls = [];

    mock('sendPixel', function(url, onSuccess, onFailure) {
      triggerUrls.push(url);
      if (onSuccess != null) {
        onSuccess();
      }
    });

    mock('getCookieValues', function(name, decode) {
        return [];
    });

    // Call runCode to run the template's code.
    runCode({
      aid: '1',
      type: 'visit',
      sid: ''
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


    assertApi('setCookie').wasCalledWith('_km', genUUID, cookie_options);
- name: visit event with eventData
  code: |
    var triggerUrls = [];

    var testCid='7a00007a-0000-47a0-8007-a00007a00007';

    mock('getCookieValues', function(name, decode) {
        return [testCid];
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
      triggerUrls.push(url);
      if (onSuccess != null) {
        onSuccess();
      }
    });

    mock('copyFromDataLayer', function(key, version) {
      if (key === 'eventData') {
        return 'formStart';
      }
    });

    // Call runCode to run the template's code.
    runCode({
      pid: '1-ade456ef78ade456ef78',
      type: 'visit',
      sid: ''
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('setCookie').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('getCookieValues').wasCalled();

    // Verify that the Cookie was correctly set
    assertApi('setCookie').wasCalledWith('_km', testCid, cookie_options);

    // Verify that the URL was correctly fired
    assertApi('sendPixel').wasCalled();
    assertThat(triggerUrls.length).isEqualTo(1);

    // track3r s handler call
    assertThat(triggerUrls[0]).isEqualTo('https://t.kmtx.io/s?pid=1-ade456ef78ade456ef78&cid=' + testCid + '&eid=' + genUUID + '&a=visit&ed=formStart&v=gtm_2&url=' + testUrl + '&ref=' + testReferrerUrl + '&ts=1&trk=trkid&t=img');
- name: lead event without eventData
  code: |
    var triggerUrls = [];

    var testCid='7a00007a-0000-47a0-8007-a00007a00007';

    mock('getCookieValues', function(name, decode) {
        return [testCid];
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
      triggerUrls.push(url);
      if (onSuccess != null) {
        onSuccess();
      }
    });

    // Call runCode to run the template's code.
    runCode({
      pid: '1-ade456ef78ade456ef78',
      type: 'lead',
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('setCookie').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('getCookieValues').wasCalled();

    // Verify that the Cookie was correctly set
    assertApi('setCookie').wasCalledWith('_km', testCid, cookie_options);

    // Verify that the URL was correctly fired
    assertApi('sendPixel').wasCalled();
    assertThat(triggerUrls.length).isEqualTo(1);

    // track3r s handler call
    assertThat(triggerUrls[0]).isEqualTo('https://t.kmtx.io/s?pid=1-ade456ef78ade456ef78&cid=' + testCid + '&eid=' + genUUID + '&a=lead&ed=&v=gtm_2&url=' + testUrl + '&ref=' + testReferrerUrl + '&ts=1&trk=trkid&t=img');
- name: timer event for visit with eventData
  code: "var triggerUrls = [];\n\nvar testCid='7a00007a-0000-47a0-8007-a00007a00007';\n\
    \nmock('getCookieValues', function(name, decode) {\n    return [testCid];\n});\n\
    \nmock('sendPixel', function(url, onSuccess, onFailure) {\n  triggerUrls.push(url);\n\
    \  if (onSuccess != null) {\n    onSuccess();\n  }\n});\n\nmock('copyFromDataLayer',\
    \ function(key, version) {\n  if (key === 'event') {\n    return 'seedtag.timer';\n\
    \  }\n  \n  if (key === 'eventData') {\n    return 'formStart';\n  }\n});\n\n\
    // Call runCode to run the template's code.\nrunCode({\n  pid: '1-ade456ef78ade456ef78',\n\
    \  type: 'visit'\n});\n\n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n\
    \n// Verify that the URL was correctly fired\nassertApi('setCookie').wasCalled();\n\
    \n// Verify that the URL was correctly fired\nassertApi('getCookieValues').wasCalled();\n\
    \n// Verify that the Cookie was correctly set\nassertApi('setCookie').wasCalledWith('_km',\
    \ testCid, cookie_options);\n\n// Verify that the URL was correctly fired\nassertApi('sendPixel').wasCalled();\n\
    assertThat(triggerUrls.length).isEqualTo(1);\n\n// track3r s handler call\nassertThat(triggerUrls[0]).isEqualTo('https://t.kmtx.io/s?pid=1-ade456ef78ade456ef78&cid='\
    \ + testCid + '&eid=' + genUUID + '&a=close&ed=formStart&v=gtm_2&url=' + testUrl\
    \ + '&ref=' + testReferrerUrl + '&ts=1&trk=trkid&t=img');\n\n"
- name: timer event for lead without eventData
  code: |+
    var triggerUrls = [];

    var testCid='7a00007a-0000-47a0-8007-a00007a00007';

    mock('getCookieValues', function(name, decode) {
        return [testCid];
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
      triggerUrls.push(url);
      if (onSuccess != null) {
        onSuccess();
      }
    });

    mock('copyFromDataLayer', function(key, version) {
      if (key === 'event') {
          return 'seedtag.timer';
      }
    });

    // Call runCode to run the template's code.
    runCode({
      pid: '1-ade456ef78ade456ef78',
      type: 'lead'
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('setCookie').wasCalled();

    // Verify that the URL was correctly fired
    assertApi('getCookieValues').wasCalled();

    // Verify that the Cookie was correctly set
    assertApi('setCookie').wasCalledWith('_km', testCid, cookie_options);

    // Verify that the URL was correctly fired
    assertApi('sendPixel').wasCalled();
    assertThat(triggerUrls.length).isEqualTo(1);

    // track3r s handler call
    assertThat(triggerUrls[0]).isEqualTo('https://t.kmtx.io/s?pid=1-ade456ef78ade456ef78&cid=' + testCid + '&eid=' + genUUID + '&a=close&ed=&v=gtm_2&url=' + testUrl + '&ref=' + testReferrerUrl + '&ts=1&trk=trkid&t=img');

setup: |-
  mock('generateRandom', 2);

  mock('getTimestampMillis', 1);

  var testUrl = 'https://www.seedtag.com';

  mock('getUrl', testUrl);

  var testReferrerUrl = 'https://www.seedtag.com/fr/our-solution';

  mock('getReferrerUrl', testReferrerUrl);

  var genUUID = 'f41000f4-1000-4f41-800f-41000f41000f';

  const cookie_options = {
    'max-age': 30 * 24 * 60 * 60,
    'secure': true
  };


___NOTES___

Created on 30/11/2023, 15:33:10


